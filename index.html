<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoverFlow Game Launcher</title>

    <!-- Define Spotify SDK callback FIRST to prevent errors -->
    <script>
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('[SPOTIFY] SDK loaded and ready');
            // The per-game-music module will handle actual initialization
        };
    </script>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ui-components.css">
    <link rel="stylesheet" href="modules/new-features-animations.css">
    <link rel="stylesheet" href="modules/app-updater-ui.css">
    <link rel="stylesheet" href="modules/custom-game-manager.css">
    <link rel="stylesheet" href="modules/mod-info-modal.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <p>Loading CoverFlow...</p>
    </div>

    <!-- Scanning Overlay -->
    <div id="scanning-overlay" class="hidden">
        <div class="spinner"></div>
        <h2>Scanning for Games...</h2>
        <div id="scan-progress-bar-overlay"></div>
    </div>

    <!-- More Dropdown Menu (Centered Modal) -->
    <div id="more-dropdown" class="dropdown-menu" style="display: none;">
        <button id="themes-btn-menu" class="dropdown-item">üé® Themes</button>
        <button id="mods-btn-menu" class="dropdown-item">üß© Mod Manager</button>
        <button id="soundtrack-btn-menu" class="dropdown-item">üéµ Game Soundtrack</button>
        <button id="youtube-soundtrack-btn-menu" class="dropdown-item">üé¨ YouTube Soundtrack</button>
        <button id="video-player-btn-menu" class="dropdown-item">üì∫ Video Player</button>
        <button id="insights-btn-menu" class="dropdown-item">üìä Gaming Insights</button>
        <button id="shortcuts-btn-menu" class="dropdown-item">‚å®Ô∏è Keyboard Shortcuts</button>
    </div>

    <!-- Main Container -->
    <div id="container">
        <!-- Top Bar -->
        <div id="top-bar">
            <div id="search-container">
                <input type="text" id="search-input" placeholder="Search albums, images, games, artists, or tags...">
                <button id="clear-search" title="Clear search">√ó</button>
            </div>
            <div id="top-controls">
                <div id="controller-status" title="Controller Status">üéÆ <span id="controller-name">No Controller</span></div>
                <button id="visual-effects-btn" title="Visual Effects">‚ú®</button>
                <div class="dropdown-container">
                    <button id="more-btn" title="More Options">‚ãØ</button>
                </div>
                <button id="settings-btn" title="Settings">‚öôÔ∏è</button>
                <button id="fullscreen-btn" title="Fullscreen (F)">‚õ∂</button>
            </div>
            <div id="window-controls">
                <button id="minimize-btn" title="Minimize">‚àí</button>
                <button id="maximize-btn" title="Maximize/Restore">‚ñ°</button>
                <button id="close-btn" title="Close">√ó</button>
            </div>
        </div>

        <!-- CoverFlow 3D Display -->
        <div id="coverflow-container">
            <div id="fps-counter" style="display: none;">
                <span id="fps-value">60</span> FPS
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container"></div>

        <!-- Info Panel -->
        <div id="info-panel">
            <div id="album-info">
                <h2 id="album-title">Album Title</h2>
                <p id="album-artist">Artist Name</p>
                <p id="album-meta">
                    <span id="album-year"></span>
                    <span id="album-genre"></span>
                </p>
                <p id="album-description" style="display: none; font-size: 0.85em; opacity: 0.8; margin-top: 8px; max-width: 300px;"></p>
                <div id="playtime-info" style="margin-top: 8px; font-size: 0.85em; opacity: 0.9;">
                    <p id="playtime-display" style="display: none; margin: 2px 0; color: #4fc3f7;"></p>
                    <p id="last-played-display" style="display: none; margin: 2px 0; color: #81c784;"></p>
                </div>
                <div id="album-actions">
                    <button id="favorite-btn" class="action-btn" title="Toggle Favorite">‚òÜ</button>
                    <button id="play-btn" class="action-btn" title="Play/Launch (or press Enter)" style="display: none;">‚ñ∂</button>
                </div>
            </div>
            <div id="album-stats">
                <span id="current-position">1</span> / <span id="total-albums">0</span>
            </div>
        </div>

        <!-- Thumbnail Navigation -->
        <div id="thumbnail-nav">
            <button id="thumb-prev" class="thumb-nav-btn">‚Äπ</button>
            <div id="thumbnail-container"></div>
            <button id="thumb-next" class="thumb-nav-btn">‚Ä∫</button>
        </div>

        <!-- Controls Info -->
        <div id="controls">
            <p>‚Üê ‚Üí Arrows | Wheel | Click | Home/End | Space | F (Fullscreen)</p>
        </div>
    </div>

    <!-- Music Visualizer Panel -->
    <div id="visualizer-panel" class="visualizer-hidden">
        <div class="visualizer-header">
            <h3>Now Playing</h3>
            <button id="visualizer-close" title="Close Visualizer">√ó</button>
        </div>
        <div id="visualizer-title">Track Title</div>
        <canvas id="visualizer-canvas"></canvas>
        <div class="visualizer-progress">
            <span id="visualizer-current-time">0:00</span>
            <input type="range" id="visualizer-seek" min="0" max="100" value="0" step="0.1">
            <span id="visualizer-duration">0:00</span>
        </div>
        <div class="visualizer-controls">
            <button id="visualizer-play-pause" class="visualizer-btn">‚è∏</button>
            <input type="range" id="visualizer-volume" min="0" max="100" value="100" title="Volume">
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Animation Speed</label>
                    <input type="range" id="animation-speed" min="1" max="20" value="10">
                    <span id="speed-value">10</span>
                </div>
                <div class="setting-group">
                    <label>Cover Spacing</label>
                    <input type="range" id="cover-spacing" min="15" max="40" value="25">
                    <span id="spacing-value">2.5</span>
                </div>
                <div class="setting-group">
                    <label>Side Angle</label>
                    <input type="range" id="side-angle" min="30" max="90" value="60">
                    <span id="angle-value">60¬∞</span>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="reflection-toggle" checked>
                        Show Reflections
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="auto-rotate">
                        Auto-Rotate (5s intervals)
                    </label>
                </div>
                <div class="setting-group">
                    <label>Background Color</label>
                    <input type="color" id="background-color" value="#000000">
                    <small class="setting-info">Change the background color of the 3D scene</small>
                </div>
                <div class="setting-group">
                    <label>Gradient Start</label>
                    <input type="color" id="gradient-start-color" value="#4fc3f7">
                    <small class="setting-info">Top color of the UI background gradient</small>
                </div>
                <div class="setting-group">
                    <label>Gradient End</label>
                    <input type="color" id="gradient-end-color" value="#1a1a2e">
                    <small class="setting-info">Bottom color of the UI background gradient</small>
                </div>

                <div class="setting-divider"></div>
                <h4 class="setting-section-title">üé® Hardware Rendering</h4>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="hardware-rendering">
                        Enable GPU Acceleration
                    </label>
                    <small id="gpu-info" class="setting-info">Detecting GPU...</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="glass-effect">
                        Glass Refraction Effect
                    </label>
                    <small class="setting-info">Realistic glass-like materials with refraction</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="bloom-effect">
                        Bloom Glow Effect
                    </label>
                    <small class="setting-info">Soft glow around covers</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="ssao-effect">
                        Ambient Occlusion (SSAO)
                    </label>
                    <small class="setting-info">Enhanced depth and shadows</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="depth-of-field-toggle">
                        Depth of Field (DOF)
                    </label>
                    <small class="setting-info">Cinematic blur effect on non-focused covers</small>
                </div>
                <div class="setting-group">
                    <label>Bloom Intensity</label>
                    <input type="range" id="bloom-intensity" min="0" max="30" value="15">
                    <span id="bloom-value">1.5</span>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="vr-mode-toggle">
                        VR/Stereo 3D Mode
                    </label>
                    <small class="setting-info">Enable side-by-side stereoscopic 3D rendering for VR headsets</small>
                </div>

                <div class="setting-divider"></div>
                <h4 class="setting-section-title">üéÆ Controller Settings</h4>

                <div class="setting-group">
                    <label>Controller Sensitivity</label>
                    <input type="range" id="controller-sensitivity" min="1" max="10" value="5">
                    <span id="sensitivity-value">5</span>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="controller-vibration" checked>
                        Vibration Feedback
                    </label>
                </div>

                <div class="setting-divider"></div>
                <h4 class="setting-section-title">üñ±Ô∏è Scroll Settings</h4>

                <div class="setting-group">
                    <label>Scroll Speed</label>
                    <input type="range" id="scroll-speed" min="0.5" max="5" step="0.1" value="1.0">
                    <span id="scroll-speed-value">1.0x</span>
                    <small class="setting-info">Adjust mouse wheel scroll sensitivity</small>
                </div>

                <div class="setting-divider"></div>
                <h4 class="setting-section-title">‚ú® Enhanced Features</h4>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="sound-effects-toggle">
                        Sound Effects
                    </label>
                    <small class="setting-info">Play sounds when navigating and launching games</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="background-music-toggle">
                        Background Music
                    </label>
                    <small class="setting-info">Play continuous background music in the launcher</small>
                </div>
                <div class="setting-group">
                    <label>Background Music Volume</label>
                    <input type="range" id="background-music-volume" min="0" max="100" value="30">
                    <span id="bg-music-volume-value">30%</span>
                    <small class="setting-info">Adjust background music volume</small>
                </div>
                <div class="setting-group">
                    <label>Background Music File</label>
                    <button id="select-bg-music-btn" class="btn primary">üìÅ Choose Music File</button>
                    <small class="setting-info" id="current-music-file-display">No file selected</small>
                </div>
                <div class="setting-group">
                    <button id="reset-bg-music-btn" class="btn secondary">Reset to Default Music</button>
                    <small class="setting-info">Restore the default background music track</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="touch-gestures-toggle">
                        Touch Gestures
                    </label>
                    <small class="setting-info">Enable swipe and tap controls for touchscreens</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="platform-animations-toggle">
                        Platform Animations
                    </label>
                    <small class="setting-info">Show platform-specific visual effects</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="dynamic-background-toggle">
                        Dynamic Background
                    </label>
                    <small class="setting-info">Change background color based on platform</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="infinite-loop-toggle">
                        Infinite Loop
                    </label>
                    <small class="setting-info">Wrap around to start/end when navigating</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="zoom-on-select-toggle">
                        Zoom on Selection
                    </label>
                    <small class="setting-info">Scale up the selected cover</small>
                </div>

                <div class="setting-divider"></div>
                <h4 class="setting-section-title">üìä Performance & Data</h4>

                <div class="setting-group">
                    <button id="reload-interface-btn" class="btn">Reload Interface</button>
                    <small class="setting-info">Reload the interface (same as Ctrl+Shift+R)</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="fps-counter-toggle">
                        Show FPS Counter
                    </label>
                    <small class="setting-info">Display performance metrics</small>
                </div>
                <div class="setting-group">
                    <label>Music Visualizer Mode</label>
                    <select id="visualizer-mode">
                        <option value="bars">Frequency Bars</option>
                        <option value="trippy">Trippy Waves</option>
                        <option value="circle">Circle Radial</option>
                        <option value="waveform">Waveform</option>
                        <option value="particles">Particle Explosion</option>
                        <option value="starfield">Starfield</option>
                        <option value="oscilloscope">Oscilloscope</option>
                        <option value="dna">DNA Helix</option>
                        <option value="matrix">Matrix Rain</option>
                        <option value="fireworks">Fireworks</option>
                        <option value="tunnel">Neon Tunnel</option>
                    </select>
                    <small class="setting-info">Choose visualizer animation style</small>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="error-logging-toggle">
                        Enable Error Logging
                    </label>
                    <small class="setting-info">Write errors to log file for debugging</small>
                </div>
                <div class="setting-group" id="view-error-log-group" style="display: none;">
                    <button id="view-error-log-btn" class="btn">View Error Log</button>
                    <button id="clear-error-log-btn" class="btn secondary">Clear Log</button>
                </div>

                <div class="setting-divider"></div>
                <h4 class="setting-section-title">üîç Console Logging</h4>

                <div class="setting-group">
                    <label>
                        <span>Log Level</span>
                        <select id="log-level-select">
                            <option value="ERROR">Error (Errors only)</option>
                            <option value="WARN">Warning (Errors + Warnings)</option>
                            <option value="INFO" selected>Info (Normal logging)</option>
                            <option value="DEBUG">Debug (Verbose logging)</option>
                            <option value="TRACE">Trace (All messages)</option>
                        </select>
                    </label>
                    <small class="setting-info">Control console output verbosity. Lower levels reduce log spam.</small>
                </div>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="disable-vr-logs">
                        <span>Disable VR module logs</span>
                    </label>
                </div>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="disable-mod-manager-logs">
                        <span>Disable Mod Manager logs</span>
                    </label>
                </div>

                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="disable-video-logs">
                        <span>Disable Video Player logs</span>
                    </label>
                </div>

                <div class="setting-divider"></div>

                <div class="setting-group">
                    <button id="export-settings-btn" class="btn">Export Settings</button>
                </div>
                <div class="setting-group">
                    <button id="import-settings-btn" class="btn">Import Settings</button>
                    <input type="file" id="settings-file-input" accept=".json" style="display: none;">
                </div>

                <div class="setting-divider"></div>
                <h4 class="setting-section-title">üéÆ Game Library</h4>

                <div class="setting-group">
                    <button id="scan-games-btn" class="btn">Scan for Games</button>
                    <small class="setting-info">Scan your computer for Steam, Epic, and Xbox games</small>
                </div>
                <div class="setting-group" id="scan-progress-group" style="display: none;">
                    <div style="margin-bottom: 8px;">
                        <small id="scan-status-text" style="color: #888;">Initializing...</small>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 20px; overflow: hidden;">
                        <div id="scan-progress-bar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div class="setting-group">
                    <button id="reload-games-btn" class="btn">Reload Games</button>
                    <small class="setting-info">Reload games from saved data</small>
                </div>
                <div class="setting-group">
                    <button id="clear-game-data-btn" class="btn secondary" style="background: linear-gradient(135deg, #e74c3c, #c0392b); border-color: #e74c3c;">Clear Game Data</button>
                    <small class="setting-info" style="color: #ff6b6b;">‚ö†Ô∏è Delete all scanned game data. You'll need to scan again.</small>
                </div>
                <div class="setting-group">
                    <small class="setting-info" id="game-count-info">Server: <span id="server-status" style="color: #888;">Checking...</span></small>
                </div>

                <div class="setting-divider"></div>
                <h4 class="setting-section-title">üìÅ Media Library</h4>

                <div class="setting-group">
                    <button id="add-media-folder-btn" class="btn">Add Media Folder</button>
                    <small class="setting-info">Browse for folders containing music, images, or videos</small>
                </div>
                <div class="setting-group">
                    <small id="media-folder-info" class="setting-info" style="color: #888;">No folders added yet</small>
                </div>

                <div class="setting-divider"></div>

                <div class="setting-group">
                    <button id="load-json-btn" class="btn">Load Albums from JSON</button>
                    <input type="file" id="json-file-input" accept=".json" style="display: none;">
                </div>
                <div class="setting-group">
                    <button id="reset-settings" class="btn secondary">Reset to Defaults</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Keyboard Shortcuts</h3>
                <button class="close-btn">√ó</button>
            </div>
            <div class="modal-body">
                <h4 class="shortcut-section">‚å®Ô∏è Keyboard Controls</h4>
                <div class="shortcut-list">
                    <div class="shortcut-item">
                        <kbd>‚Üê</kbd> <kbd>‚Üí</kbd>
                        <span>Navigate left/right</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Home</kbd>
                        <span>Go to first album</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>End</kbd>
                        <span>Go to last album</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Space</kbd>
                        <span>Random album</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>I</kbd>
                        <span>Show album info/details</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>F</kbd>
                        <span>Toggle fullscreen</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Esc</kbd>
                        <span>Exit fullscreen/Close modals</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>?</kbd>
                        <span>Show this help</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>1-9</kbd>
                        <span>Jump to position (10%, 20%, ...)</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Click Center</kbd>
                        <span>Show album details</span>
                    </div>
                </div>

                <h4 class="shortcut-section">üéÆ Controller/Gamepad</h4>
                <div class="shortcut-list">
                    <div class="shortcut-item">
                        <kbd>D-Pad ‚Üê ‚Üí</kbd> <kbd>L-Stick</kbd>
                        <span>Navigate left/right</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>A Button</kbd> <kbd>Cross ‚úï</kbd>
                        <span>Select/Confirm</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>B Button</kbd> <kbd>Circle ‚óã</kbd>
                        <span>Back/Cancel</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>X Button</kbd> <kbd>Square ‚ñ°</kbd>
                        <span>Show album info/details</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Y Button</kbd> <kbd>Triangle ‚ñ≥</kbd>
                        <span>Random album</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>R-Stick</kbd>
                        <span>Move glowing cursor</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>LB/RB</kbd> <kbd>L1/R1</kbd>
                        <span>Navigate left/right (fast)</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>LT/RT</kbd> <kbd>L2/R2</kbd>
                        <span>Jump to start/end</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Start</kbd> <kbd>Options</kbd>
                        <span>Open settings</span>
                    </div>
                    <div class="shortcut-item">
                        <kbd>Select</kbd> <kbd>Share</kbd>
                        <span>Toggle fullscreen</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Info Modal -->
    <div id="info-modal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>Album Details</h3>
                <button class="close-btn">√ó</button>
            </div>
            <div class="modal-body info-modal-body">
                <div class="info-modal-layout">
                    <div class="info-modal-media">
                        <div id="info-cover-container"></div>
                        <div id="info-video-container" style="display: none;">
                            <video id="info-video" controls loop></video>
                        </div>
                    </div>
                    <div class="info-modal-details">
                        <h2 id="info-modal-title">Album Title</h2>
                        <h3 id="info-modal-artist">Artist Name</h3>
                        <div class="info-divider"></div>
                        <div class="info-row">
                            <span class="info-label">Year:</span>
                            <span id="info-modal-year">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Genre:</span>
                            <span id="info-modal-genre">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Color:</span>
                            <span id="info-modal-color">-</span>
                        </div>
                        <div id="info-modal-description" style="margin-top: 20px;">
                            <span class="info-label">Description:</span>
                            <p id="info-description-text">No description available.</p>
                        </div>
                        <button id="launch-game-btn" style="display: none; margin-top: 20px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
                            üéÆ Launch Game
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controller Cursor -->
    <div id="controller-cursor" style="display: none;">
        <div class="cursor-inner"></div>
    </div>

    <!-- Three.js library -->
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <!-- html2canvas for heatmap export -->
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- YouTube IFrame API for music integration -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Spotify Web Playback SDK (callback defined in head) -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <!-- Post-processing effects from unpkg (more reliable) -->
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/math/SimplexNoise.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/SSAOShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/SSAOPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/BokehShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/BokehPass.js"></script>

    <!-- CoverFlow Modular Architecture -->
    <!-- Logger (must load first) -->
    <script src="modules/logger.js"></script>

    <!-- Core utilities (no dependencies) -->
    <script src="modules/coverflow-settings.js"></script>
    <script src="modules/coverflow-textures.js"></script>
    <script src="modules/coverflow-ui-utils.js"></script>

    <!-- UI components (depends on textures) -->
    <script src="modules/coverflow-navigation.js"></script>
    <script src="modules/coverflow-ui.js"></script>

    <!-- New features modules -->
    <script src="modules/quick-launch.js"></script>
    <script src="modules/game-tags.js"></script>
    <script src="modules/library-export.js"></script>
    <script src="modules/backlog-manager.js"></script>
    <script src="modules/screenshot-gallery.js"></script>
    <script src="modules/visual-effects.js"></script>

    <!-- Coverflow enhancement modules -->
    <script src="modules/coverflow-enhancements.js"></script>
    <script src="modules/sound-effects.js"></script>
    <script src="modules/background-music.js"></script>
    <script src="modules/touch-gestures.js"></script>
    <script src="modules/platform-animations.js"></script>
    <script src="modules/session-insights.js"></script>
    <script src="modules/youtube-integration.js"></script>
    <script src="modules/soundtrack-player.js"></script>
    <script src="modules/video-player.js"></script>
    <script src="modules/vr-mode.js"></script>
    <script src="modules/vr-game-filter.js"></script>
    <script src="modules/update-notifications.js"></script>
    <script src="modules/app-updater-ui.js"></script>
    <script src="modules/portable-mode.js"></script>

    <!-- New Feature Modules (2025) -->
    <script src="modules/per-game-music.js"></script>
    <script src="modules/gaming-heatmap.js"></script>
    <script src="modules/dynamic-background.js"></script>
    <script src="modules/cover-art-editor.js"></script>
    <script src="modules/custom-game-manager.js"></script>
    <script src="modules/unified-mod-manager.js"></script>
    <script src="modules/new-features-settings.js"></script>
    <script src="modules/features-manager.js"></script>
    <!-- Main coverflow (uses all modules via Object.assign in constructor) -->
    <script src="coverflow.js"></script>
    <script src="ui-components.js"></script>

    <!-- Initialize features -->
    <script>
        // Initialize window controls immediately on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            // Hide window controls initially if not in Electron
            if (!window.electronAPI) {
                const windowControls = document.getElementById('window-controls');
                if (windowControls) {
                    windowControls.classList.add('hidden');
                    console.log('[WINDOW-CONTROLS] Hidden (not in Electron)');
                }
                return; // Exit early if not in Electron
            }

            // We're in Electron - continue with initialization
            const windowControls = document.getElementById('window-controls');
            const topBar = document.getElementById('top-bar');

            if (!windowControls) {
                console.error('[WINDOW-CONTROLS] Window controls element not found!');
                return;
            }

            // Check if frosted glass mode is enabled from settings
            // Try both possible keys (coverflow-settings and coverflowSettings)
            const savedSettings = localStorage.getItem('coverflow-settings') || localStorage.getItem('coverflowSettings');
            const settings = savedSettings ? JSON.parse(savedSettings) : {};
            const frostedGlassEnabled = settings.frostedGlassUI || false;

            console.log('[WINDOW-CONTROLS] Initializing window controls');
            console.log('[WINDOW-CONTROLS] Frosted glass enabled:', frostedGlassEnabled);
            console.log('[WINDOW-CONTROLS] Settings:', settings);

            // Show window controls in Electron (unless frosted glass mode is active)
            // In normal mode (frostedGlassEnabled = false), show the controls
            // In frosted glass mode (frostedGlassEnabled = true), hide the controls
            if (frostedGlassEnabled) {
                windowControls.classList.add('hidden');
                console.log('[WINDOW-CONTROLS] Window controls hidden (frosted glass mode)');
            } else {
                windowControls.classList.remove('hidden');
                windowControls.style.display = 'flex'; // Explicitly set display
                windowControls.style.visibility = 'visible'; // Explicitly set visibility
                windowControls.style.opacity = '1'; // Explicitly set opacity
                console.log('[WINDOW-CONTROLS] Window controls shown (normal mode)');
            }

            // Make top-bar draggable (for moving the window)
            if (topBar) {
                topBar.style.webkitAppRegion = 'drag';
                topBar.style.appRegion = 'drag';

                // Make buttons not draggable
                const buttons = topBar.querySelectorAll('button, input');
                buttons.forEach(btn => {
                    btn.style.webkitAppRegion = 'no-drag';
                    btn.style.appRegion = 'no-drag';
                });
            }

            // Window control button handlers
            document.getElementById('minimize-btn')?.addEventListener('click', () => {
                console.log('[WINDOW-CONTROLS] Minimize clicked');
                window.electronAPI.minimizeWindow();
            });

            document.getElementById('maximize-btn')?.addEventListener('click', () => {
                console.log('[WINDOW-CONTROLS] Maximize clicked');
                window.electronAPI.maximizeWindow();
            });

            document.getElementById('close-btn')?.addEventListener('click', () => {
                console.log('[WINDOW-CONTROLS] Close clicked');
                window.electronAPI.closeWindow();
            });

            // Also update fullscreen button to use new API
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', () => {
                    window.electronAPI.toggleFullscreen();
                });
            }
        });

        // Old load event listener (keeping for compatibility)
        if (window.electronAPI) {
            window.addEventListener('load', () => {
                const windowControls = document.getElementById('window-controls');
                const topBar = document.getElementById('top-bar');

                // Check if frosted glass mode is enabled from settings
                // Try both possible keys (coverflow-settings and coverflowSettings)
                const savedSettings = localStorage.getItem('coverflow-settings') || localStorage.getItem('coverflowSettings');
                const settings = savedSettings ? JSON.parse(savedSettings) : {};
                const frostedGlassEnabled = settings.frostedGlassUI || false;

                console.log('[WINDOW-CONTROLS] Initializing window controls');
                console.log('[WINDOW-CONTROLS] Frosted glass enabled:', frostedGlassEnabled);
                console.log('[WINDOW-CONTROLS] Settings:', settings);

                // Show window controls in Electron (unless frosted glass mode is active)
                if (windowControls) {
                    // In normal mode (frostedGlassEnabled = false), show the controls
                    // In frosted glass mode (frostedGlassEnabled = true), hide the controls
                    if (frostedGlassEnabled) {
                        windowControls.classList.add('hidden');
                        console.log('[WINDOW-CONTROLS] Window controls hidden (frosted glass mode)');
                    } else {
                        windowControls.classList.remove('hidden');
                        windowControls.style.display = 'flex'; // Explicitly set display
                        console.log('[WINDOW-CONTROLS] Window controls shown (normal mode)');
                    }
                } else {
                    console.error('[WINDOW-CONTROLS] Window controls element not found!');
                }

                // Make top-bar draggable (for moving the window)
                // NOTE: This is now handled by CSS, but keeping for browsers that need JS fallback
                if (topBar) {
                    topBar.style.webkitAppRegion = 'drag';
                    topBar.style.appRegion = 'drag';

                    // Make buttons not draggable
                    const buttons = topBar.querySelectorAll('button, input');
                    buttons.forEach(btn => {
                        btn.style.webkitAppRegion = 'no-drag';
                        btn.style.appRegion = 'no-drag';
                    });
                }

                // NOTE: Window control event listeners are now attached in DOMContentLoaded above
                // Removed duplicate listeners to prevent double-click issues
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('[INIT] DOMContentLoaded fired');
            console.log('[INIT] window.coverflow:', window.coverflow);
            console.log('[INIT] window.FeaturesManager:', window.FeaturesManager);

            // Wait for coverflow to initialize
            setTimeout(() => {
                console.log('[INIT] Timeout fired after 1000ms');
                console.log('[INIT] window.coverflow:', window.coverflow);
                console.log('[INIT] window.FeaturesManager:', window.FeaturesManager);

                if (window.coverflow && window.FeaturesManager) {
                    window.featuresManager = new FeaturesManager();
                    window.featuresManager.init(window.coverflow);
                    console.log('[FEATURES] Initialized: Quick Launch, Tags, Backlog, Screenshots, Themes, Stats, Collections');
                } else {
                    console.error('[INIT] Failed to initialize FeaturesManager!');
                    console.error('[INIT] window.coverflow:', window.coverflow);
                    console.error('[INIT] window.FeaturesManager:', window.FeaturesManager);
                }
            }, 1000);
        });
    </script>
</body>
</html>